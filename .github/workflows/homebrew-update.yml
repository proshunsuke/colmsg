name: Update Homebrew

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œï¼ˆHomebrewã‚’æ›´æ–°ã›ãšç¢ºèªã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: proshunsuke/homebrew-colmsg
          token: ${{ secrets.HOMEBREW_TOKEN }}
      
      - name: Set version
        id: version
        run: |
          # æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          VERSION=$(curl -s https://api.github.com/repos/proshunsuke/colmsg/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          if [[ -z "$VERSION" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Update formula
        run: |
          cd Formula
          VERSION=${{ steps.version.outputs.version }}
          
          echo "=== Current Formula ==="
          cat colmsg.rb
          echo "======================"
          
          # x86_64ã¨aarch64ã®SHA256ã‚’è¨ˆç®—
          X86_URL="https://github.com/${{ github.repository }}/releases/download/$VERSION/colmsg-$VERSION-x86_64-apple-darwin.tar.gz"
          ARM_URL="https://github.com/${{ github.repository }}/releases/download/$VERSION/colmsg-$VERSION-aarch64-apple-darwin.tar.gz"
          
          # SHA256ã®è¨ˆç®—
          echo "ğŸ“‹ SHA256ã®è¨ˆç®—"
          X86_SHA=$(curl -sL "$X86_URL" | shasum -a 256 | awk '{print $1}')
          ARM_SHA=$(curl -sL "$ARM_URL" | shasum -a 256 | awk '{print $1}')
          
          echo "âœ… Intelç‰ˆã®SHA256: $X86_SHA"
          echo "âœ… ARMç‰ˆã®SHA256: $ARM_SHA"
          
          echo ""
          echo "VERSION: $VERSION"
          echo "X86_URL: $X86_URL"
          echo "X86_SHA: $X86_SHA"
          echo "ARM_URL: $ARM_URL"
          echo "ARM_SHA: $ARM_SHA"
          
          # Formulaãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          # URLã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°ï¼ˆv3.2.0/colmsg-v3.2.0 â†’ v3.2.1/colmsg-v3.2.1ï¼‰
          sed -i "s|/v[0-9.]\+/colmsg-v[0-9.]\+|/${VERSION}/colmsg-${VERSION}|g" colmsg.rb
          
          # Intelç”¨SHA256ã®æ›´æ–°
          sed -i "/Hardware::CPU.intel?/,/sha256/ s/sha256 \".*\"/sha256 \"$X86_SHA\"/" colmsg.rb
          
          # ARMç”¨SHA256ã®æ›´æ–°
          sed -i "/Hardware::CPU.arm?/,/sha256/ s/sha256 \".*\"/sha256 \"$ARM_SHA\"/" colmsg.rb
          
          echo -e "\n=== Updated Formula ==="
          cat colmsg.rb
          echo "======================"
      
      - name: Validate Ruby syntax
        run: |
          cd Formula
          echo "ğŸ“‹ Rubyãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
          ruby -c colmsg.rb && echo "âœ… Formulaã®æ§‹æ–‡ã¯æ­£å¸¸ã§ã™" || {
            echo "âŒ Formulaã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            exit 1
          }
      
      - name: Show git diff
        run: |
          echo "ğŸ“ Gitå·®åˆ†"
          git diff --color=always
          
          # å·®åˆ†ãŒãªã„å ´åˆã®è­¦å‘Š
          if [[ -z "$(git diff)" ]]; then
            echo "âš ï¸  è­¦å‘Š: å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ—¢ã«æ›´æ–°æ¸ˆã¿ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
          fi
      
      - name: Show final summary
        run: |
          echo "========================================="
          echo "ğŸ“Š æœ€çµ‚ç¢ºèªã‚µãƒãƒªãƒ¼"
          echo "========================================="
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.version.outputs.version }}"
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"  # v prefix ã‚’å‰Šé™¤
          echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: colmsg version${VERSION}"
          echo ""
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ä»¥ä¸‹ã®æ“ä½œã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"
            echo "  - Gitã¸ã®ã‚³ãƒŸãƒƒãƒˆ"
            echo "  - GitHubã¸ã®ãƒ—ãƒƒã‚·ãƒ¥"
          else
            echo "âœ… å®Ÿéš›ã®Homebrewæ›´æ–°ã‚’å®Ÿè¡Œã—ã¾ã™"
          fi
          echo "========================================="
      
      - name: Commit and push
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"  # v prefix ã‚’å‰Šé™¤
          git commit -m "colmsg version${VERSION}"
          git push