name: Update AUR

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³å®Ÿè¡Œï¼ˆAURã‚’æ›´æ–°ã›ãšç¢ºèªã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux/archlinux:base-devel
    steps:
      - name: Install required packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git namcap openssh
      
      - name: Set version
        id: version
        run: |
          # æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          if [[ -z "$VERSION" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          echo "Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            StrictHostKeyChecking no" > ~/.ssh/config
          # AURã®ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã‚’è¿½åŠ 
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
      
      - name: Clone AUR package
        run: |
          GIT_SSH_COMMAND="ssh -i ~/.ssh/aur -o StrictHostKeyChecking=no" git clone ssh://aur@aur.archlinux.org/colmsg.git aur-colmsg
      
      - name: Update PKGBUILD
        run: |
          cd aur-colmsg
          VERSION=${{ steps.version.outputs.version }}
          VERSION=${VERSION#v}  # v prefix ã‚’å‰Šé™¤
          
          echo "=== Current PKGBUILD ==="
          cat PKGBUILD
          echo "======================="
          
          # PKGBUILDã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD
          
          # ã‚½ãƒ¼ã‚¹ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
          COMMIT_HASH=$(git ls-remote https://github.com/${{ github.repository }}.git refs/tags/v$VERSION | cut -f1)
          if [[ -z "$COMMIT_HASH" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚° v$VERSION ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: $COMMIT_HASH"
          sed -i "s/source=.*/source=(\"git+https:\/\/github.com\/${{ github.repository }}.git#commit=$COMMIT_HASH\")/" PKGBUILD
          
          echo -e "\n=== Updated PKGBUILD ==="
          cat PKGBUILD
          echo "======================="
      
      - name: Validate PKGBUILD syntax
        run: |
          cd aur-colmsg
          echo "ğŸ“‹ PKGBUILDã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
          bash -n PKGBUILD && echo "âœ… PKGBUILDã®æ§‹æ–‡ã¯æ­£å¸¸ã§ã™" || {
            echo "âŒ PKGBUILDã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            exit 1
          }
      
      - name: Generate .SRCINFO
        run: |
          cd aur-colmsg
          echo "ğŸ“‹ .SRCINFOã®ç”Ÿæˆ"
          makepkg --printsrcinfo > .SRCINFO
          echo "=== Generated .SRCINFO ==="
          cat .SRCINFO
          echo "========================="
      
      - name: Run namcap checks
        run: |
          cd aur-colmsg
          echo "ğŸ” namcapã«ã‚ˆã‚‹PKGBUILDã®æ¤œè¨¼"
          namcap PKGBUILD || true
          echo ""
      
      - name: Build package verification
        run: |
          cd aur-colmsg
          echo "ğŸ—ï¸  ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ"
          
          # érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ“ãƒ«ãƒ‰
          useradd -m builder
          chown -R builder:builder .
          
          # ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
          su builder -c "makepkg -sf --noconfirm" || {
            echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          }
          
          echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
          
          # ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æƒ…å ±è¡¨ç¤º
          echo -e "\n=== ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ==="
          ls -la *.pkg.tar.*
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†…å®¹ç¢ºèª
          echo -e "\n=== ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†…å®¹ ==="
          tar -tvf *.pkg.tar.* | head -20
          
          # namcapã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          echo -e "\nğŸ” namcapã«ã‚ˆã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ¤œè¨¼"
          namcap *.pkg.tar.* || true
      
      - name: Show git diff
        run: |
          cd aur-colmsg
          echo "ğŸ“ Gitå·®åˆ†"
          git diff --color=always || echo "ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯å·®åˆ†ãªã—ï¼‰"
          
          # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
          git add -N PKGBUILD .SRCINFO 2>/dev/null || true
          git diff --cached --color=always
      
      - name: Show final summary
        run: |
          cd aur-colmsg
          echo "========================================="
          echo "ğŸ“Š æœ€çµ‚ç¢ºèªã‚µãƒãƒªãƒ¼"
          echo "========================================="
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.version.outputs.version }}"
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"  # v prefix ã‚’å‰Šé™¤
          echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: colmsg version${VERSION}"
          echo ""
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³: ä»¥ä¸‹ã®æ“ä½œã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"
            echo "  - Gitã¸ã®ã‚³ãƒŸãƒƒãƒˆ"
            echo "  - AURã¸ã®ãƒ—ãƒƒã‚·ãƒ¥"
          else
            echo "âœ… å®Ÿéš›ã®AURæ›´æ–°ã‚’å®Ÿè¡Œã—ã¾ã™"
          fi
          echo "========================================="
      
      - name: Commit and push
        if: ${{ !inputs.dry_run }}
        run: |
          cd aur-colmsg
          git config user.name "${{ secrets.AUR_USERNAME }}"
          git config user.email "${{ secrets.AUR_EMAIL }}"
          git add PKGBUILD .SRCINFO
          VERSION="${{ steps.version.outputs.version }}"
          VERSION="${VERSION#v}"  # v prefix ã‚’å‰Šé™¤
          git commit -m "colmsg version${VERSION}"
          git push